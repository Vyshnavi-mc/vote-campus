<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        body {
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 100%;
            margin: auto;
            padding: 20px;
        }

        .form-control,
        .form-select {
            border: none;
            border-bottom: 2px solid rgb(139 139 139);
            border-radius: 0;
            box-shadow: none !important;
            padding: 10px;
            transition: border-bottom 0.3s ease-in-out;
        }

        .form-control:focus,
        .form-select:focus {
            border-bottom: 2px solid #D35400;
            outline: none;
        }

        .hidden {
            display: none;
        }

        .btn-custom {
            background-color: #D35400;
            border: none;
            padding: 10px;
            font-size: 16px;
            color: white;
            width: 100%;
        }

        .btn-custom:hover {
            background-color: #B94600;
        }

        .card {
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .form-container {
                margin-top: 20px;
            }

            .img-fluid {
                width: 60%;
            }
        }

        @media (max-width: 576px) {
            .img-fluid {
                width: 80%;
            }
        }
    </style>
</head>

<body class="bg-white">
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="row w-100 align-items-center">
            <div class="col-md-6 text-center">
                <img class="img-fluid w-50" src="../Images/vote campus signup.png" alt="Brand Logo">
            </div>
            <div class="col-md-6 form-container">
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 style="color:rgb(26, 46, 53)"><b>SIGN <span style="color:rgb(255, 115, 92)">UP</b></span></h3>
                        <a href="./home.html" class="btn btn-outline-secondary btn-sm">Back to Login</a>
                    </div>
                    <p class="text-muted">Please enter the details to create an account!</p>
                    <form id="signup-form" class="form mt-3">
                        <div class="mb-3">
                            <label for="student-fullName" class="form-label">Full Name</label>
                            <input id="student-fullName" type="text" class="form-control" placeholder="Ex: John Doe" required>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="voting-role" class="form-label">Sign up as</label>
                                <select id="voting-role" class="form-select" onchange="toggleFields()" required>
                                    <option selected disabled>Choose role...</option>
                                    <option value="Student">Student</option>
                                    <option value="Faculty">Faculty</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="student-department" class="form-label">Department</label>
                                <select id="student-department" class="form-select"></select>
                            </div>
                        </div>

                        <!-- Hidden Fields for Students & Faculty -->
                        <div id="student-fields" class="row mb-3 hidden">
                            <div class="col-md-6">
                                <label for="student-adm-no" class="form-label">Admission Number</label>
                                <input id="student-adm-no" type="text" class="form-control" placeholder="Ex: 19/217/EC/KGR">
                            </div>
                            <div class="col-md-6">
                                <label for="batch-year" class="form-label">Batch (Year)</label>
                                <select id="batch-year" class="form-select">
                                    <option value="">No Batches Available</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3 hidden" id="faculty-fields">
                            <div class="col-md-6">
                                <label for="is-tutor" class="form-label">Is Faculty?</label>
                                <select id="is-tutor" class="form-select" onchange="toggleTutorFields()">
                                    <option selected disabled>Choose...</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 hidden" id="batch-year-div">
                                <label for="faculty-batch-year" class="form-label">Batch (Year)</label>
                                <select id="faculty-batch-year" class="form-select"></select>
                            </div>
                        </div>

                        <!-- Secret Code Always Available for Faculty and Admin -->
                        <div class="mb-3 hidden" id="secret-code-div">
                            <label for="secret-code" class="form-label">Enter Secret Code</label>
                            <input id="secret-code" type="text" class="form-control" placeholder="Enter code">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pass-first" class="form-label">Password</label>
                                <input id="pass-first" type="password" class="form-control" placeholder="Enter password" required>
                            </div>
                            <div class="col-md-6">
                                <label for="re-pass-first" class="form-label">Confirm Password</label>
                                <input id="re-pass-first" type="password" class="form-control" placeholder="Re-enter password" required>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-custom mt-2">Sign Up</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Fetch Departments
        async function fetchDepartments() {
            try {
                const response = await fetch("http://localhost:3000/api/department/get-department");
                const data = await response.json();
                const departmentDropdown = document.getElementById("student-department");
                departmentDropdown.innerHTML = `<option selected disabled>Choose department...</option>`;

                data.forEach(dept => {
                    let option = document.createElement("option");
                    option.value = dept._id;
                    option.textContent = dept.departmentShortName;
                    departmentDropdown.appendChild(option);
                });

                departmentDropdown.addEventListener("change", fetchBatches);
            } catch (error) {
                console.error("Error fetching departments:", error);
            }
        }

        // Fetch Batches
        async function fetchBatches() {
            const departmentRef = document.getElementById("student-department").value;
            const batchDropdown = document.getElementById("batch-year");
            const facultyBatchDropdown = document.getElementById("faculty-batch-year");

            try {
                const response = await fetch("http://localhost:3000/api/batch/get-batch", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ departmentRef })
                });

                const data = await response.json();
                batchDropdown.innerHTML = `<option selected disabled>Select year...</option>`;
                facultyBatchDropdown.innerHTML = `<option selected disabled>Select year...</option>`;

                data.forEach(batch => {
                    let option = document.createElement("option");
                    option.value = batch._id;
                    option.textContent = batch.batchName;
                    batchDropdown.appendChild(option);
                    facultyBatchDropdown.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error("Error fetching batches:", error);
            }
        }

        // Toggle Fields Based on Role
        function toggleFields() {
            let role = document.getElementById("voting-role").value;
            let studentFields = document.getElementById("student-fields");
            let facultyFields = document.getElementById("faculty-fields");
            let secretCodeDiv = document.getElementById("secret-code-div");

            studentFields.classList.add("hidden");
            facultyFields.classList.add("hidden");
            secretCodeDiv.classList.add("hidden");

            if (role === "Student") {
                studentFields.classList.remove("hidden");
            } else if (role === "Faculty") {
                facultyFields.classList.remove("hidden");
                secretCodeDiv.classList.remove("hidden"); // Secret code for faculty
            } else if (role === "Admin") {
                secretCodeDiv.classList.remove("hidden");
            }
        }

        // Show/Hide Batch for Faculty if Tutor
        function toggleTutorFields() {
            let isTutor = document.getElementById("is-tutor").value;
            let batchYearDiv = document.getElementById("batch-year-div");
            batchYearDiv.classList.toggle("hidden", isTutor !== "Yes");
        }

        // Handle Form Submission
        document.getElementById("signup-form").addEventListener("submit", async function (event) {
            event.preventDefault();

            const requestBody = {
                userFullName: document.getElementById("student-fullName").value,
                userEmail: document.getElementById("student-email").value,
                signUpRole: document.getElementById("voting-role").value,
                departmentRef: document.getElementById("student-department").value,
                studentAdmissionNumber: document.getElementById("student-adm-no")?.value || "",
                batchRef: document.getElementById("batch-year").value || "",
                facultyBatchRef: document.getElementById("faculty-batch-year").value || "",
                password: document.getElementById("pass-first").value,
                secretCode: document.getElementById("secret-code").value || ""
            };

            if (requestBody.password !== document.getElementById("re-pass-first").value) {
                showToast("Passwords do not match!", "error");
                return;
            }

            try {
                const response = await fetch("http://localhost:3000/api/user/add/add-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (response.ok) {
                    showToast("User registered successfully!", "success");
                    setTimeout(() => {
                        window.location.href = "home.html";
                    }, 2000);
                } else {
                    showToast(data.error || "Something went wrong!", "error");
                }
            } catch (error) {
                console.error("Signup error:", error);
                showToast("Error connecting to server!", "error");
            }
        });

        // Show Toast Message
        function showToast(message, type) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                backgroundColor: type === "success" ? "#28a745" : "#dc3545",
            }).showToast();
        }

        // Load Departments on Page Load
        document.addEventListener("DOMContentLoaded", fetchDepartments);
    </script>
</body>

</html>
